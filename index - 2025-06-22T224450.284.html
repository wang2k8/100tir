<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turbuloop</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css">
    <style>
        :root {
            --primary-color: #4da8ff;
            --secondary-color: #ff5555;
            --bg-color: #252526;
            --panel-bg: #1e1e1e;
            --text-color: #d4d4d4;
            --accent-color: #ffffff;
            --shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
            --border-radius: 8px;
        }

        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
            transition: background 0.3s ease;
        }

        .container {
            display: flex;
            min-height: 100vh;
            flex-direction: row;
            padding: 16px;
            gap: 16px;
            max-width: 1600px;
            margin: 0 auto;
        }

        .sidebar {
            width: 360px;
            background: var(--panel-bg);
            padding: 16px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow-y: auto;
            max-height: 80vh;
        }

        .sidebar.left {
            order: 1;
        }

        .sidebar.right {
            order: 3;
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            order: 2;
        }

        .header {
            text-align: center;
            margin-bottom: 16px;
        }

        .header h1 {
            font-size: 1.8em;
            margin: 0;
            color: var(--primary-color);
            text-shadow: 0 0 8px rgba(77, 168, 255, 0.3);
            letter-spacing: 0.5px;
        }

        #image-upload {
            display: none;
        }

        .upload-btn {
            background: linear-gradient(90deg, var(--primary-color), #3a8ae6);
            color: var(--accent-color);
            padding: 12px 24px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            text-align: center;
            display: block;
            font-weight: 500;
            margin: 0 auto;
        }

        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(77, 168, 255, 0.3);
        }

        #crop-container {
            max-width: 100%;
            margin: 0;
            display: none;
            border-radius: var(--border-radius);
            overflow: hidden;
            position: relative;
        }

        #crop-ok-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: var(--primary-color);
            color: #ffffff;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }

        #crop-ok-btn:hover {
            background: #3a8ae6;
        }

        #preview {
            width: 100%;
            max-width: 960px;
            aspect-ratio: 16 / 9;
            background: #000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            display: none;
        }

        #preview.active {
            display: block;
        }

        #preview-canvas {
            width: 100%;
            height: 100%;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .control-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 12px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding: 8px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 4px;
        }

        .panel-header h3 {
            margin: 0;
            font-size: 0.9em;
            font-weight: 500;
            color: var(--primary-color);
        }

        .panel-content {
            display: none;
            padding: 12px 0;
        }

        .panel-content.active {
            display: block;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 12px;
        }

        .control-group label {
            font-size: 0.85em;
            color: #b3b3b3;
            display: flex;
            justify-content: space-between;
            font-weight: 400;
        }

        .control-group input[type="range"],
        .control-group input[type="number"],
        .control-group select {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 4px;
            color: var(--text-color);
            padding: 8px;
            font-size: 0.85em;
            transition: all 0.2s ease;
        }

        .control-group input:focus,
        .control-group select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 6px rgba(77, 168, 255, 0.2);
            outline: none;
        }

        .control-group input[type="range"] {
            accent-color: var(--primary-color);
            height: 4px;
            border-radius: 2px;
        }

        .control-group span {
            color: var(--primary-color);
            font-weight: 500;
        }

        .timeline {
            width: 100%;
            max-width: 960px;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            margin: 16px 0;
            position: relative;
            cursor: pointer;
            display: none;
        }

        .timeline.active {
            display: block;
        }

        #timeline-progress {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), #3a8ae6);
            border-radius: 4px;
            transition: width 0.1s linear;
            box-shadow: 0 0 6px rgba(77, 168, 255, 0.4);
        }

        .export-btn {
            background: linear-gradient(90deg, var(--secondary-color), #e64444);
            color: var(--accent-color);
            padding: 12px 24px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.9em;
            font-weight: 500;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(255, 85, 85, 0.3);
        }

        .export-btn:disabled {
            background: linear-gradient(90deg, #7a3a3a, #6a2f2f);
            cursor: not-allowed;
            transform: none;
        }

        .export-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #loading-indicator {
            display: none;
            color: var(--primary-color);
            font-size: 0.85em;
            font-weight: 500;
            animation: pulse 1.5s infinite;
        }

        #error-message {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #2e2e2e;
            color: #ffffff;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            max-width: 400px;
            text-align: center;
            font-size: 0.9em;
            z-index: 1001;
        }

        #error-message p {
            margin: 0 0 12px;
        }

        #error-message a {
            color: var(--primary-color);
            text-decoration: underline;
        }

        #error-message button {
            background: var(--primary-color);
            color: #ffffff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 12px;
        }

        #error-message button:hover {
            background: #3a8ae6;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .theme-toggle {
            position: absolute;
            top: 16px;
            right: 16px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .theme-toggle svg {
            width: 20px;
            height: 20px;
            fill: var(--text-color);
        }

        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
                align-items: center;
            }

            .sidebar {
                width: 100%;
                max-width: 360px;
            }

            .sidebar.left, .sidebar.right {
                order: 0;
            }

            .main-content {
                order: 1;
                width: 100%;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 12px;
            }

            .sidebar {
                max-height: 50vh;
            }

            #error-message {
                max-width: 90%;
            }

            .upload-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <button class="theme-toggle" id="theme-toggle" title="Chuyển đổi giao diện">
        <svg viewBox="0 0 24 24">
            <path d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 12.728l-.707.707M6.343 17.657l-.707.707M12 8a4 4 0 100 8 4 4 0 000-8z"/>
        </svg>
    </button>
    <div class="container">
        <div class="sidebar left">
            <div class="header">
                <h1>Turbuloop</h1>
            </div>
            <label for="image-upload" class="upload-btn">Tải ảnh lên</label>
            <input type="file" id="image-upload" accept="image/*">
            <div class="controls">
                <div class="control-panel">
                    <div class="panel-header">
                        <h3>Hiệu ứng biến dạng</h3>
                        <span>▼</span>
                    </div>
                    <div class="panel-content active">
                        <div class="control-group">
                            <label>Mức độ: <span id="amount-value">50</span></label>
                            <input type="range" id="amount" min="0" max="200" step="1" value="50">
                        </div>
                        <div class="control-group">
                            <label>Kích thước: <span id="size-value">50</span></label>
                            <input type="range" id="size" min="10" max="200" step="1" value="50">
                        </div>
                        <div class="control-group">
                            <label>Dịch chuyển X: <span id="offset-x-value">0</span></label>
                            <input type="number" id="offset-x" min="-500" max="500" step="1" value="0">
                        </div>
                        <div class="control-group">
                            <label>Dịch chuyển Y: <span id="offset-y-value">0</span></label>
                            <input type="number" id="offset-y" min="-500" max="500" step="1" value="0">
                        </div>
                    </div>
                </div>
                <div class="control-panel">
                    <div class="panel-header">
                        <h3>Hiệu ứng động</h3>
                        <span>▼</span>
                    </div>
                    <div class="panel-content active">
                        <div class="control-group">
                            <label>Độ phức tạp: <span id="complexity-value">2</span></label>
                            <input type="range" id="complexity" min="1" max="5" step="0.1" value="2">
                        </div>
                        <div class="control-group">
                            <label>Tiến hóa: <span id="evolution-value">0</span></label>
                            <input type="range" id="evolution" min="0" max="360" step="1" value="0">
                        </div>
                        <div class="control-group">
                            <label>Tốc độ: <span id="speed-value">1</span></label>
                            <input type="range" id="speed" min="0.1" max="5" step="0.1" value="1">
                        </div>
                        <div class="control-group">
                            <label>Thời lượng: <span id="duration-value">10</span>s</label>
                            <input type="range" id="duration" min="5" max="30" step="1" value="10">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="main-content">
            <div id="crop-container">
                <img id="crop-image" style="max-width: 100%;">
                <button id="crop-ok-btn">OK</button>
            </div>
            <div id="preview">
                <canvas id="preview-canvas"></canvas>
            </div>
            <div class="timeline" id="timeline">
                <div id="timeline-progress"></div>
            </div>
        </div>
        <div class="sidebar right">
            <div class="controls">
                <div class="control-panel">
                    <div class="panel-header">
                        <h3>Giao diện</h3>
                        <span>▼</span>
                    </div>
                    <div class="panel-content active">
                        <div class="control-group">
                            <label>Độ trong suốt: <span id="opacity-value">100</span>%</label>
                            <input type="range" id="opacity" min="0" max="100" step="1" value="100">
                        </div>
                        <div class="control-group">
                            <label>Màu đỏ: <span id="color-red-value">1</span></label>
                            <input type="range" id="color-red" min="0" max="2" step="0.01" value="1">
                        </div>
                        <div class="control-group">
                            <label>Màu xanh lá: <span id="color-green-value">1</span></label>
                            <input type="range" id="color-green" min="0" max="2" step="0.01" value="1">
                        </div>
                        <div class="control-group">
                            <label>Màu xanh dương: <span id="color-blue-value">1</span></label>
                            <input type="range" id="color-blue" min="0" max="2" step="0.01" value="1">
                        </div>
                    </div>
                </div>
                <div class="control-panel">
                    <div class="panel-header">
                        <h3>Xuất file</h3>
                        <span>▼</span>
                    </div>
                    <div class="panel-content active">
                        <div class="control-group export-group">
                            <label>Định dạng xuất:</label>
                            <select id="export-format">
                                <option value="mp4" selected>MP4</option>
                                <option value="gif">GIF</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <button class="export-btn" id="export-btn" disabled>Xuất file</button>
                            <span id="loading-indicator">Đang xuất... <span id="export-progress">0%</span></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="error-message">
        <p>Xin lỗi, xuất trực tiếp định dạng GIF hiện không được hỗ trợ.</p>
        <p>File MP4 đã được tải xuống. Vui lòng truy cập <a href="https://marshallku.com/gifconverter/" target="_blank">trình chuyển đổi này</a> để chuyển từ MP4 sang GIF.</p>
        <button id="close-error">Đóng</button>
    </div>
    <script>
        // Theme toggle functionality
        const themeToggle = document.getElementById('theme-toggle');
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('light-theme');
            if (document.body.classList.contains('light-theme')) {
                document.documentElement.style.setProperty('--bg-color', '#d4d4d4');
                document.documentElement.style.setProperty('--panel-bg', '#ffffff');
                document.documentElement.style.setProperty('--text-color', '#333333');
                document.documentElement.style.setProperty('--accent-color', '#000000');
            } else {
                document.documentElement.style.setProperty('--bg-color', '#252526');
                document.documentElement.style.setProperty('--panel-bg', '#1e1e1e');
                document.documentElement.style.setProperty('--text-color', '#d4d4d4');
                document.documentElement.style.setProperty('--accent-color', '#ffffff');
            }
        });

        // Accordion functionality
        document.querySelectorAll('.panel-header').forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                content.classList.toggle('active');
                header.querySelector('span').textContent = content.classList.contains('active') ? '▼' : '▶';
            });
        });

        const imageUpload = document.getElementById('image-upload');
        const cropContainer = document.getElementById('crop-container');
        const cropImage = document.getElementById('crop-image');
        const cropOkBtn = document.getElementById('crop-ok-btn');
        const preview = document.getElementById('preview');
        const previewCanvas = document.getElementById('preview-canvas');
        const timeline = document.getElementById('timeline');
        const timelineProgress = document.getElementById('timeline-progress');
        const exportBtn = document.getElementById('export-btn');
        const exportFormat = document.getElementById('export-format');
        const loadingIndicator = document.getElementById('loading-indicator');
        const exportProgress = document.getElementById('export-progress');
        const errorMessage = document.getElementById('error-message');
        let closeError = document.getElementById('close-error');

        let cropper, scene, camera, renderer, texture, material, mesh;
        let animationStartTime = Date.now();
        let animationDuration = 10;
        let isPlaying = true;

        // Attach close-error event listener
        function attachCloseErrorListener() {
            closeError = document.getElementById('close-error');
            if (closeError) {
                closeError.addEventListener('click', () => {
                    errorMessage.style.display = 'none';
                    console.log('Error message closed');
                });
            }
        }
        attachCloseErrorListener();

        imageUpload.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                try {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        cropImage.src = event.target.result;
                        cropContainer.style.display = 'block';
                        preview.classList.remove('active');
                        timeline.classList.remove('active');
                        if (cropper) cropper.destroy();
                        cropper = new Cropper(cropImage, {
                            aspectRatio: 16 / 9,
                            viewMode: 1,
                            ready() {
                                console.log('Cropper initialized successfully');
                            },
                            error(err) {
                                console.error('Cropper initialization failed:', err);
                            }
                        });
                    };
                    reader.readAsDataURL(file);
                } catch (e) {
                    console.error('File reading failed:', e);
                    errorMessage.innerHTML = `
                        <p>Lỗi khi đọc file ảnh: ${e.message}</p>
                        <p>Vui lòng thử tải lên lại.</p>
                        <button id="close-error">Đóng</button>
                    `;
                    errorMessage.style.display = 'block';
                    attachCloseErrorListener();
                }
            } else {
                console.error('No file selected');
            }
        });

        cropOkBtn.addEventListener('click', () => {
            if (!cropper) {
                console.error('Cropper not initialized');
                errorMessage.innerHTML = `
                    <p>Lỗi: Công cụ cắt ảnh chưa sẵn sàng.</p>
                    <p>Vui lòng thử lại.</p>
                    <button id="close-error">Đóng</button>
                `;
                errorMessage.style.display = 'block';
                attachCloseErrorListener();
                return;
            }
            try {
                const croppedCanvas = cropper.getCroppedCanvas();
                if (!croppedCanvas) {
                    console.error('Failed to get cropped canvas');
                    errorMessage.innerHTML = `
                        <p>Lỗi khi xử lý ảnh cắt.</p>
                        <p>Vui lòng thử lại.</p>
                        <button id="close-error">Đóng</button>
                    `;
                    errorMessage.style.display = 'block';
                    attachCloseErrorListener();
                    return;
                }
                cropContainer.style.display = 'none';
                preview.classList.add('active');
                timeline.classList.add('active');
                initThreeJS(croppedCanvas);
            } catch (e) {
                console.error('Crop processing failed:', e);
                errorMessage.innerHTML = `
                    <p>Lỗi xử lý ảnh cắt: ${e.message}</p>
                    <p>Vui lòng thử lại.</p>
                    <button id="close-error">Đóng</button>
                `;
                errorMessage.style.display = 'block';
                attachCloseErrorListener();
            }
        });

        function initThreeJS(image) {
            try {
                scene = new THREE.Scene();
                camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0, 1);
                renderer = new THREE.WebGLRenderer({ canvas: previewCanvas, alpha: true });
                renderer.setSize(800, 800 * (9 / 16));
                renderer.setPixelRatio(window.devicePixelRatio);

                texture = new THREE.Texture(image);
                texture.needsUpdate = true;

                const vertexShader = `
                    varying vec2 vUv;
                    void main() {
                        vUv = uv;
                        gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                    }
                `;

                const fragmentShader = `
                    uniform sampler2D uTexture;
                    uniform float uTime;
                    uniform float uAmount;
                    uniform float uSize;
                    uniform vec2 uOffset;
                    uniform float uComplexity;
                    uniform float uEvolution;
                    uniform float uSpeed;
                    uniform float uOpacity;
                    uniform vec3 uColorBalance;
                    uniform float uDuration;
                    varying vec2 vUv;

                    vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
                    vec2 mod289(vec2 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
                    vec3 permute(vec3 x) { return mod289(((x*34.0)+1.0)*x); }

                    float snoise(vec2 v) {
                        const vec4 C = vec4(0.211324865405187, 0.366025403784439, -0.577350269189626, 0.024390243902439);
                        vec2 i = floor(v + dot(v, C.yy));
                        vec2 x0 = v - i + dot(i, C.xx);
                        vec2 i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
                        vec4 x12 = x0.xyxy + C.xxzz;
                        x12.xy -= i1;
                        i = mod289(i);
                        vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0)) + i.x + vec3(0.0, i1.x, 1.0));
                        vec3 m = max(0.5 - vec3(dot(x0,x0), dot(x12.xy,x12.xy), dot(x12.zw,x12.zw)), 0.0);
                        m = m*m; m = m*m;
                        vec3 x = 2.0 * fract(p * C.www) - 1.0;
                        vec3 h = abs(x) - 0.5;
                        vec3 ox = floor(x + 0.5);
                        vec3 a0 = x - ox;
                        m *= 1.79284291400159 - 0.85373472095314 * (a0*a0 + h*h);
                        vec3 g;
                        g.x = a0.x * x0.x + h.x * x0.y;
                        g.yz = a0.yz * x12.xz + h.yz * x12.yw;
                        return 130.0 * dot(m, g);
                    }

                    void main() {
                        vec2 uv = vUv;
                        vec2 offset = uOffset / 800.0;
                        float scale = 100.0 / uSize;
                        float t = uTime * uSpeed / uDuration;
                        float cyclicTime = sin(3.14159265359 * t) * 0.5 + 0.5;

                        float n = 0.0;
                        float amp = 1.0;
                        for (float i = 0.0; i < uComplexity; i++) {
                            n += snoise(uv * scale * pow(2.0, i) + cyclicTime + uEvolution / 360.0) * amp;
                            amp *= 0.5;
                        }
                        n /= (1.0 - pow(0.5, uComplexity));

                        vec2 displace = vec2(n, n) * (uAmount / 800.0);
                        uv += displace;

                        vec4 color = texture2D(uTexture, uv);
                        color.rgb *= uColorBalance;
                        color.a *= uOpacity;
                        gl_FragColor = color;
                    }
                `;

                material = new THREE.ShaderMaterial({
                    uniforms: {
                        uTexture: { value: texture },
                        uTime: { value: 0 },
                        uAmount: { value: 50 },
                        uSize: { value: 50 },
                        uOffset: { value: new THREE.Vector2(0, 0) },
                        uComplexity: { value: 2 },
                        uEvolution: { value: 0 },
                        uSpeed: { value: 1 },
                        uOpacity: { value: 1 },
                        uColorBalance: { value: new THREE.Vector3(1, 1, 1) },
                        uDuration: { value: 10 }
                    },
                    vertexShader,
                    fragmentShader
                });

                mesh = new THREE.Mesh(new THREE.PlaneGeometry(2, 2), material);
                scene.add(mesh);

                exportBtn.disabled = false;
                animate();
                console.log('Three.js initialized successfully');
            } catch (e) {
                console.error('Three.js initialization failed:', e);
                errorMessage.innerHTML = `
                    <p>Lỗi khởi tạo hiệu ứng: ${e.message}</p>
                    <p>Vui lòng thử lại hoặc sử dụng trình duyệt khác.</p>
                    <button id="close-error">Đóng</button>
                `;
                errorMessage.style.display = 'block';
                attachCloseErrorListener();
            }
        }

        function animate() {
            if (!isPlaying) return requestAnimationFrame(animate);
            requestAnimationFrame(animate);
            const time = (Date.now() - animationStartTime) / 1000;
            material.uniforms.uTime.value = time;
            timelineProgress.style.width = `${(time % animationDuration) / animationDuration * 100}%`;
            renderer.render(scene, camera);
        }

        function updateUniforms() {
            try {
                const amount = parseFloat(document.getElementById('amount').value);
                const size = parseFloat(document.getElementById('size').value);
                const offsetX = parseFloat(document.getElementById('offset-x').value);
                const offsetY = parseFloat(document.getElementById('offset-y').value);
                const complexity = parseFloat(document.getElementById('complexity').value);
                const evolution = parseFloat(document.getElementById('evolution').value);
                const speed = parseFloat(document.getElementById('speed').value);
                const opacity = parseFloat(document.getElementById('opacity').value) / 100;
                const colorRed = parseFloat(document.getElementById('color-red').value);
                const colorGreen = parseFloat(document.getElementById('color-green').value);
                const colorBlue = parseFloat(document.getElementById('color-blue').value);
                animationDuration = parseFloat(document.getElementById('duration').value);

                material.uniforms.uAmount.value = amount;
                material.uniforms.uSize.value = size;
                material.uniforms.uOffset.value.set(offsetX, offsetY);
                material.uniforms.uComplexity.value = complexity;
                material.uniforms.uEvolution.value = evolution;
                material.uniforms.uSpeed.value = speed;
                material.uniforms.uOpacity.value = opacity;
                material.uniforms.uColorBalance.value.set(colorRed, colorGreen, colorBlue);
                material.uniforms.uDuration.value = animationDuration;

                document.getElementById('amount-value').textContent = amount;
                document.getElementById('size-value').textContent = size;
                document.getElementById('offset-x-value').textContent = offsetX;
                document.getElementById('offset-y-value').textContent = offsetY;
                document.getElementById('complexity-value').textContent = complexity.toFixed(1);
                document.getElementById('evolution-value').textContent = evolution;
                document.getElementById('speed-value').textContent = speed.toFixed(1);
                document.getElementById('opacity-value').textContent = document.getElementById('opacity').value;
                document.getElementById('color-red-value').textContent = colorRed.toFixed(2);
                document.getElementById('color-green-value').textContent = colorGreen.toFixed(2);
                document.getElementById('color-blue-value').textContent = colorBlue.toFixed(2);
                document.getElementById('duration-value').textContent = animationDuration;
            } catch (error) {
                console.error('Update uniforms failed:', error);
                errorMessage.innerHTML = `
                    <p>Lỗi cập nhật cài đặt: ${error.message}</p>
                    <p>Vui lòng thử lại.</p>
                    <button id="close-error">Đóng</button>
                `;
                errorMessage.style.display = 'block';
                attachCloseErrorListener();
            }
        }

        ['amount', 'size', 'offset-x', 'offset-y', 'complexity', 'evolution', 'speed', 'opacity', 'color-red', 'color-green', 'color-blue', 'duration'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateUniforms);
        });

        timeline.addEventListener('click', (e) => {
            try {
                const rect = timeline.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const progress = x / rect.width;
                animationStartTime = Date.now() - (progress * animationDuration * 1000);
                material.uniforms.uTime.value = progress * animationDuration;
                timelineProgress.style.width = `${progress * 100}%`;
                isPlaying = true;
            } catch (error) {
                console.error('Timeline click handler failed:', error);
                errorMessage.innerHTML = `
                    <p>Lỗi thao tác timeline: ${error.message}</p>
                    <p>Vui lòng thử lại.</p>
                    <button id="close-error">Đóng</button>
                `;
                errorMessage.style.display = 'block';
                attachCloseErrorListener();
            }
        });

        exportBtn.addEventListener('click', () => {
            console.log('Export button clicked');
            exportBtn.disabled = true;
            loadingIndicator.style.display = 'inline';
            errorMessage.style.display = 'none';
            exportProgress.textContent = '0%';
            const format = exportFormat.value;
            const isGifRequested = format === 'gif';

            if (!window.MediaRecorder || !MediaRecorder.isTypeSupported('video/mp4')) {
                console.error('MediaRecorder not supported');
                errorMessage.innerHTML = `
                    <p>Trình duyệt không hỗ trợ xuất file MP4.</p>
                    <p>Vui lòng sử dụng Chrome hoặc Firefox.</p>
                    <button id="close-error">Đóng</button>
                `;
                errorMessage.style.display = 'block';
                attachCloseErrorListener();
                exportBtn.disabled = false;
                loadingIndicator.style.display = 'none';
                exportProgress.textContent = '0%';
                return;
            }

            try {
                const stream = previewCanvas.captureStream(30);
                const recorder = new MediaRecorder(stream, { mimeType: 'video/mp4' });
                const chunks = [];

                recorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        chunks.push(e.data);
                        console.log('Data chunk received:', e.data.size);
                    }
                };

                recorder.onstop = () => {
                    try {
                        const blob = new Blob(chunks, { type: 'video/mp4' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'turbuloop_animation.mp4';
                        a.click();
                        URL.revokeObjectURL(url);
                        exportBtn.disabled = false;
                        loadingIndicator.style.display = 'none';
                        console.log('Export completed successfully');

                        if (isGifRequested) {
                            console.log('Scheduling GIF error message display');
                            setTimeout(() => {
                                errorMessage.innerHTML = `
                                    <p>Xin lỗi, xuất trực tiếp định dạng GIF hiện không được hỗ trợ.</p>
                                    <p>File MP4 đã được tải xuống. Vui lòng truy cập <a href="https://marshallku.com/gifconverter/" target="_blank">trình chuyển đổi này</a> để chuyển từ MP4 sang GIF.</p>
                                    <button id="close-error">Đóng</button>
                                `;
                                errorMessage.style.display = 'block';
                                attachCloseErrorListener();
                                console.log('GIF error message displayed');
                            }, 1000);
                        }
                    } catch (error) {
                        console.error('Export finalization failed:', error);
                        errorMessage.innerHTML = `
                            <p>Xuất file thất bại: ${error.message}</p>
                            <p>Vui lòng thử lại hoặc sử dụng trình duyệt khác.</p>
                            <button id="close-error">Đóng</button>
                        `;
                        errorMessage.style.display = 'block';
                        attachCloseErrorListener();
                    }
                };

                recorder.start();
                console.log('MediaRecorder started');

                const fps = 30;
                const frames = Math.round(animationDuration * fps);
                const frameDuration = animationDuration / frames;
                let frame = 0;

                function captureVideoFrame() {
                    if (frame >= frames) {
                        recorder.stop();
                        console.log('MediaRecorder stopped');
                        return;
                    }

                    material.uniforms.uTime.value = frame * frameDuration;
                    renderer.render(scene, camera);
                    frame++;
                    const progress = Math.round((frame / frames) * 100);
                    exportProgress.textContent = `${progress}%`;
                    requestAnimationFrame(captureVideoFrame);
                }

                captureVideoFrame();
            } catch (error) {
                console.error('Export failed:', error);
                errorMessage.innerHTML = `
                    <p>Xuất file thất bại: ${error.message}</p>
                    <p>Vui lòng thử giảm thời lượng hoặc sử dụng trình duyệt khác.</p>
                    <button id="close-error">Đóng</button>
                `;
                errorMessage.style.display = 'block';
                attachCloseErrorListener();
                exportBtn.disabled = false;
                loadingIndicator.style.display = 'none';
                exportProgress.textContent = '0%';
            }
        });

        updateUniforms();
    </script>
</body>
</html>